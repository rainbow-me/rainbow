# This flow covers:
# [x] Swap ETH to ERC20 with paused automine
# [x] Cancel a pending swap transaction (Type 2 / EIP-1559)
# [x] Verify SpeedUpAndCancelSheet loads and cancel works
#
# Requires exclusive Anvil mining control â€” do not run in parallel.

appId: ${APP_ID}
tags:
  - wallet
  - sequential
---
- launchApp:
    clearState: true
    clearKeychain: true
    arguments:
      isE2ETest: true
- runFlow: ../../utils/Prepare.yaml
- runFlow: ../../utils/ImportWalletWithKey.yaml

# Load Anvil + tab helpers
- runScript:
    file: ../../helpers/anvil.js
- runScript:
    file: ../../utils/coordinates.js

# Send ETH to test wallet
- openLink: rainbow://e2e/fund-wallet?amount=20

# Connect to Anvil (test network)
- openLink: rainbow://e2e/connect-anvil

# Open swap screen
- tapOn:
    id: swap-button
- assertVisible:
    id: swap-screen

# Select DAI as output token
- tapOn: 'Find a token to buy'
- inputText: 'DAI'
- hideKeyboard
- tapOn:
    id: token-to-buy-dai-1
- assertVisible: 'DAI.*'

# Close settings and go to review
- tapOn:
    id: swap-bottom-action-button
- tapOn:
    id: swap-bottom-action-button
- assertVisible:
    id: review-panel

# Pause automine so the swap tx stays pending
- evalScript: ${output.anvil.evm_setAutomine(false)}

# Execute swap (long press)
- longPressOn:
    id: swap-bottom-action-button
- runFlow: ../../utils/MaybeInputPin.yaml

# Navigate to Activity tab
- tapOn:
    point: ${output.tabCoordinates.activityTab}

# Tap the pending swap transaction row
- retry:
    maxRetries: 5
    commands:
      - assertVisible: 'Swapping'
- tapOn: 'Swapping'

# Assert context menu shows Cancel option
- retry:
    maxRetries: 3
    commands:
      - assertVisible: 'Cancel'
- tapOn: 'Cancel'

# Assert SpeedUpAndCancelSheet loads
- retry:
    maxRetries: 5
    commands:
      - assertVisible:
          id: speed-up-and-cancel-sheet

# Cancel button (attempt cancellation) should be visible
- assertVisible:
    id: speed-up-cancel-sheet-cancel-button

# Tap attempt cancellation
- tapOn:
    id: speed-up-cancel-sheet-cancel-button

# Re-enable automine and mine a block to flush pending txs
- evalScript: ${output.anvil.evm_setAutomine(true)}
- evalScript: ${output.anvil.evm_mine()}
