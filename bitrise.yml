---
format_version: 1.1.0
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
app:
  envs:
  - SOME_VAR: SOME_VAL
trigger_map:
- push_branch: "*"
  workflow: build_setup
- pull_request_source_branch: "*"
  workflow: tests
  pull_request_target_branch: develop
workflows:
  build_setup:
    steps:
    - activate-ssh-key@4.0.5:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@4.0.18: {}
    - script@1.1.6:
        inputs:
        - content: |-
            #!/bin/bash
            brew update
            brew tap wix/brew
            brew install --HEAD applesimutils
            brew install watchman
        title: Installing deps via Brew
    - nvm@1.2.2:
        inputs:
        - node_version: 10.15.3
    - yarn@0.1.1:
        inputs:
        - command: global add react-native-cli
        title: Installing react-native-cli
    - yarn@0.1.1:
        inputs:
        - command: global add detox-cli
        title: Installing detox-cli
    - yarn@0.1.1:
        inputs:
        - command: install --network-timeout 300000 --frozen-lockfile --network-concurrency
            1
        title: Installing dependencies via yarn
    - script@1.1.6:
        inputs:
        - content: |-
            #!/bin/bash
            pod repo update
        title: Updating Pods repo
    - yarn@0.1.1:
        inputs:
        - command: install-pods
        title: Installing pods
    - script@1.1.6:
        inputs:
        - content: |-
            #!/bin/bash
            detox clean-framework-cache && detox build-framework-cache
        title: Build detox framework cache
    before_run: 
    after_run: 
  lint:
    before_run: []
    after_run: []
    steps:
    - yarn@0.1.1:
        inputs:
        - command: lint
        title: Linting for Errors
  detox_tests:
    before_run: []
    after_run: []
    steps:
    - script@1.1.6:
        inputs:
        - content: |-
            #!/bin/bash

            detox build --configuration ios.sim.release
        title: Detox - Build Release App
    - script@1.1.6:
        inputs:
        - content: |-
            #!/bin/bash

            detox test --configuration ios.sim.release --cleanup
        title: Detox - Run E2E Tests
  tests:
    before_run:
    - build_setup
    - lint
    - detox_tests
    after_run: []
  testflight:
    before_run:
    - build_setup
    steps:
    - fastlane@2.7.0:
        inputs:
        - lane: beta
    - fastlane@2.7.0:
        inputs:
        - lane: refresh_dsyms
