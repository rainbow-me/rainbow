import { isEmpty } from 'lodash';
import { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import isEqual from 'react-fast-compare';
import { useDispatch, useSelector } from 'react-redux';
import { createSelector } from 'reselect';
import { useCallbackOne } from 'use-memo-one';
import { getChart } from '../../handlers/uniswap';
import {
  assetChartsFallbackReceived,
  chartsUpdateChartType,
  DEFAULT_CHART_TYPE,
} from '../../redux/charts';
import { emitChartsRequest } from '../../redux/explorer';
import { daysFromTheFirstTx } from '../../utils/ethereumUtils';
import useAsset from '../useAsset';
import logger from 'logger';

const formatChartData = chart => {
  if (!chart || isEmpty(chart)) return null;
  return chart.map(([x, y]) => ({ x, y }));
};

const chartSelector = createSelector(
  ({ charts: { charts, chartsFallback, chartType, fetchingCharts } }) => ({
    charts,
    chartsFallback,
    chartType,
    fetchingCharts,
  }),
  (_, address) => address,
  (state, address) => {
    const { charts, chartsFallback, chartType, fetchingCharts } = state;
    const chartsForAsset = {
      ...chartsFallback?.[address],
      ...charts?.[address],
    };

    return {
      chart: formatChartData(chartsForAsset?.[chartType]),
      chartsForAsset,
      chartType,
      fetchingCharts,
    };
  }
);

function useWasNotFetchingDataForTheLast5Seconds(isFetchingData) {
  const [isFetchingDataForLonger, setIsFetchingDataForLonger] = useState(false);
  const timeout = useRef();
  useEffect(() => {
    if (isFetchingData) {
      clearTimeout(timeout.current);

      setIsFetchingDataForLonger(false);
    } else {
      setTimeout(() => {
        setIsFetchingDataForLonger(true);
      }, 5000);
    }
  }, [isFetchingData]);
  return isFetchingDataForLonger;
}
const chart = [
  { x: 1599336900, y: 10.33750196859343 },
  { x: 1599337200, y: 10.62111003128614 },
  { x: 1599337500, y: 10.710544106552087 },
  { x: 1599337800, y: 10.905003126677746 },
  { x: 1599338100, y: 11.04177324383438 },
  { x: 1599338400, y: 11.015312067447981 },
  { x: 1599338700, y: 11.129406243966345 },
  { x: 1599339000, y: 11.251804670850884 },
  { x: 1599339300, y: 11.293637811767004 },
  { x: 1599339600, y: 11.277280034244933 },
  { x: 1599339900, y: 11.335311967370194 },
  { x: 1599340200, y: 11.19232005859268 },
  { x: 1599340500, y: 11.187056968864036 },
  { x: 1599340800, y: 11.198224787212002 },
  { x: 1599341100, y: 11.212936952975301 },
  { x: 1599341400, y: 11.894725262966357 },
  { x: 1599341700, y: 11.899636421526733 },
  { x: 1599342000, y: 11.975869638046124 },
  { x: 1599342300, y: 11.92068210161427 },
  { x: 1599342600, y: 11.867118298139742 },
  { x: 1599342900, y: 11.84969669779194 },
  { x: 1599343200, y: 11.916721752154535 },
  { x: 1599343500, y: 11.915280924931835 },
  { x: 1599343800, y: 11.990080926272558 },
  { x: 1599344100, y: 12.006144717631125 },
  { x: 1599344400, y: 12.04639359988125 },
  { x: 1599344700, y: 11.973222772466658 },
  { x: 1599345000, y: 11.988009174447892 },
  { x: 1599345300, y: 12.002767790367374 },
  { x: 1599345600, y: 11.919362619873118 },
  { x: 1599345900, y: 11.867667327516966 },
  { x: 1599346200, y: 11.833179782082071 },
  { x: 1599346500, y: 11.804980574695552 },
  { x: 1599346800, y: 11.776468673642517 },
  { x: 1599347100, y: 11.588622269508464 },
  { x: 1599347400, y: 11.66551100360927 },
  { x: 1599347700, y: 11.743094991915456 },
  { x: 1599348000, y: 11.74380739184835 },
  { x: 1599348300, y: 11.717475597864217 },
  { x: 1599348600, y: 11.738167792331485 },
  { x: 1599348900, y: 11.725976637850009 },
  { x: 1599349200, y: 11.806522136663443 },
  { x: 1599349500, y: 12.033592075581629 },
  { x: 1599349800, y: 12.110459062283462 },
  { x: 1599350100, y: 12.120998194271637 },
  { x: 1599350400, y: 12.088890163875535 },
  { x: 1599350700, y: 12.052387654580688 },
  { x: 1599351000, y: 11.975994968158256 },
  { x: 1599351300, y: 12.027147346880687 },
  { x: 1599351600, y: 12.15497372096217 },
  { x: 1599351900, y: 12.273875263537871 },
  { x: 1599352200, y: 12.365091913189646 },
  { x: 1599352500, y: 12.365431259599136 },
  { x: 1599352800, y: 12.30163456167795 },
  { x: 1599353100, y: 12.179035688362315 },
  { x: 1599353400, y: 12.180771028424399 },
  { x: 1599353700, y: 12.19364285604475 },
  { x: 1599354000, y: 12.192781062297417 },
  { x: 1599354300, y: 12.332758572061655 },
  { x: 1599354600, y: 12.316094640258259 },
  { x: 1599354900, y: 12.194737745603087 },
  { x: 1599355200, y: 12.218003576139452 },
  { x: 1599355500, y: 12.244513304815829 },
  { x: 1599355800, y: 12.196206198424274 },
  { x: 1599356100, y: 12.195481312468946 },
  { x: 1599356400, y: 12.103847802308564 },
  { x: 1599356700, y: 12.091690570214146 },
  { x: 1599357000, y: 12.105520522497383 },
  { x: 1599357300, y: 12.092496694071361 },
  { x: 1599357600, y: 11.977680451529187 },
  { x: 1599357900, y: 11.992720420779175 },
  { x: 1599358200, y: 12.03254289930985 },
  { x: 1599358500, y: 11.99937677254168 },
  { x: 1599358800, y: 11.96637558521391 },
  { x: 1599359100, y: 11.937555984019236 },
  { x: 1599359400, y: 11.476432228734684 },
  { x: 1599359700, y: 11.481923200023644 },
  { x: 1599360000, y: 11.472372373841079 },
  { x: 1599360300, y: 11.501314183793987 },
  { x: 1599360600, y: 11.50238067234898 },
  { x: 1599360900, y: 11.508660407019963 },
  { x: 1599361200, y: 11.515986764136109 },
  { x: 1599361500, y: 11.578895448706897 },
  { x: 1599361800, y: 11.612956634169057 },
  { x: 1599362100, y: 11.620102208810133 },
  { x: 1599362400, y: 11.624942091514795 },
  { x: 1599362700, y: 11.550299059427248 },
  { x: 1599363000, y: 11.524588653464741 },
  { x: 1599363300, y: 11.487890798368987 },
  { x: 1599363600, y: 11.592509929790472 },
  { x: 1599363900, y: 11.591102644646151 },
  { x: 1599364200, y: 11.54621036919815 },
  { x: 1599364500, y: 11.539648747714182 },
  { x: 1599364800, y: 11.52037524837689 },
  { x: 1599365100, y: 11.513720930576708 },
  { x: 1599365400, y: 11.577979640796409 },
  { x: 1599365700, y: 11.582537804292768 },
  { x: 1599366000, y: 11.532037139872198 },
  { x: 1599366300, y: 11.502929118018676 },
  { x: 1599366600, y: 11.428621651337304 },
  { x: 1599366900, y: 11.338113045416613 },
  { x: 1599367200, y: 11.3628675781381 },
  { x: 1599367500, y: 11.323783854922958 },
  { x: 1599367800, y: 11.140065039169983 },
  { x: 1599368100, y: 11.088391783066466 },
  { x: 1599368400, y: 11.060884304577192 },
  { x: 1599368700, y: 11.060805783251118 },
  { x: 1599369000, y: 11.022192777999603 },
  { x: 1599369300, y: 10.910441748283649 },
  { x: 1599369600, y: 10.851002202234364 },
  { x: 1599369900, y: 10.833763370015365 },
  { x: 1599370200, y: 10.915468628602307 },
  { x: 1599370500, y: 10.904910106152025 },
  { x: 1599370800, y: 11.030526973966854 },
  { x: 1599371100, y: 11.02687532005746 },
  { x: 1599371400, y: 11.035012234572322 },
  { x: 1599371700, y: 10.98723642514327 },
  { x: 1599372000, y: 11.000960997160794 },
  { x: 1599372300, y: 11.012498828788095 },
  { x: 1599372600, y: 10.971756580495242 },
  { x: 1599372900, y: 10.93329115471253 },
  { x: 1599373200, y: 10.920695127811124 },
  { x: 1599373500, y: 10.900968402017991 },
  { x: 1599373800, y: 10.604170707588313 },
  { x: 1599374100, y: 10.593540667162836 },
  { x: 1599374400, y: 10.634370317724525 },
  { x: 1599374700, y: 10.59430250318837 },
  { x: 1599375000, y: 10.65790612483069 },
  { x: 1599375300, y: 10.718174488174073 },
  { x: 1599375600, y: 10.739706045721567 },
  { x: 1599375900, y: 10.811970791018256 },
  { x: 1599376200, y: 10.891307704839313 },
  { x: 1599376500, y: 10.877314747661405 },
  { x: 1599376800, y: 10.737972461184153 },
  { x: 1599377100, y: 10.842102228993582 },
  { x: 1599377400, y: 10.848548310858499 },
  { x: 1599377700, y: 10.863478647981934 },
  { x: 1599378000, y: 11.4565365717823 },
  { x: 1599378300, y: 11.728887729109832 },
  { x: 1599378600, y: 12.091150775714965 },
  { x: 1599378900, y: 12.272799783562498 },
  { x: 1599379200, y: 12.337622152288473 },
  { x: 1599379500, y: 12.477637706971436 },
  { x: 1599379800, y: 12.742026362840598 },
  { x: 1599380100, y: 13.024055274028742 },
  { x: 1599380400, y: 12.9580283240743 },
  { x: 1599380700, y: 12.966801532147471 },
  { x: 1599381000, y: 13.165487442799861 },
  { x: 1599381300, y: 13.312228897980809 },
  { x: 1599381600, y: 13.302088943243637 },
  { x: 1599381900, y: 13.53428465412346 },
  { x: 1599382200, y: 13.666419164115759 },
  { x: 1599382500, y: 13.710294800944826 },
  { x: 1599382800, y: 13.749697861157342 },
  { x: 1599383100, y: 13.835596532420626 },
  { x: 1599383400, y: 13.967928892921664 },
  { x: 1599383700, y: 13.807339163498147 },
  { x: 1599384000, y: 13.786865962522478 },
  { x: 1599384300, y: 13.666725733610225 },
  { x: 1599384600, y: 13.674568170068067 },
  { x: 1599384900, y: 13.747784701069898 },
  { x: 1599385200, y: 13.738176208923289 },
  { x: 1599385500, y: 13.644178067051728 },
  { x: 1599385800, y: 13.659833356795698 },
  { x: 1599386100, y: 13.60054540321011 },
  { x: 1599386400, y: 13.66362488236245 },
  { x: 1599386700, y: 13.754617618869347 },
  { x: 1599387000, y: 13.984654762669035 },
  { x: 1599387300, y: 13.972582098430067 },
  { x: 1599387600, y: 13.948616929122377 },
  { x: 1599387900, y: 13.876547584308932 },
  { x: 1599388200, y: 13.83010284641797 },
  { x: 1599388500, y: 13.817213000576677 },
  { x: 1599388800, y: 13.827402367912256 },
  { x: 1599389100, y: 13.827228447760087 },
  { x: 1599389400, y: 13.942284376771736 },
  { x: 1599389700, y: 13.982003803128398 },
  { x: 1599390000, y: 14.134343598771578 },
  { x: 1599390300, y: 14.117843311325913 },
  { x: 1599390600, y: 14.21726602372167 },
  { x: 1599390900, y: 14.17148359914897 },
  { x: 1599391200, y: 13.965829432876202 },
  { x: 1599391500, y: 13.986742773109523 },
  { x: 1599391800, y: 14.20827061918969 },
  { x: 1599392100, y: 14.204936109634701 },
  { x: 1599392400, y: 14.330796735556511 },
  { x: 1599392700, y: 14.340225173153739 },
  { x: 1599393000, y: 14.443608910758066 },
  { x: 1599393300, y: 14.451395001925983 },
  { x: 1599393600, y: 14.448116647750018 },
  { x: 1599393900, y: 14.586069547763095 },
  { x: 1599394200, y: 14.597303304201432 },
  { x: 1599394500, y: 14.471899385843491 },
  { x: 1599394800, y: 14.495921909689889 },
  { x: 1599395100, y: 14.510715156540023 },
  { x: 1599395400, y: 14.571689931638678 },
  { x: 1599395700, y: 14.537810278367939 },
  { x: 1599396000, y: 14.522470060938298 },
  { x: 1599396300, y: 14.4937533115555 },
  { x: 1599396600, y: 14.486050425331602 },
  { x: 1599396900, y: 14.47939455377807 },
  { x: 1599397200, y: 14.533923746529192 },
  { x: 1599397500, y: 14.54085582433928 },
  { x: 1599397800, y: 14.359892767027855 },
  { x: 1599398100, y: 14.358608978952377 },
  { x: 1599398400, y: 14.368108436633571 },
  { x: 1599398700, y: 14.387071882766907 },
  { x: 1599399000, y: 14.413153173140495 },
  { x: 1599399300, y: 14.380778289403203 },
  { x: 1599399600, y: 14.430126182244907 },
  { x: 1599399900, y: 14.406616959036631 },
  { x: 1599400200, y: 14.358485966044244 },
  { x: 1599400500, y: 14.396839046287864 },
  { x: 1599400800, y: 14.471078291439271 },
  { x: 1599401100, y: 14.436476117316525 },
  { x: 1599401400, y: 14.426642291394028 },
  { x: 1599401700, y: 14.383763559495824 },
  { x: 1599402000, y: 14.358192063651092 },
  { x: 1599402300, y: 14.37372771810949 },
  { x: 1599402600, y: 14.266088343527343 },
  { x: 1599402900, y: 14.266910406933103 },
  { x: 1599403200, y: 14.30908946281933 },
  { x: 1599403500, y: 14.261730450956547 },
  { x: 1599403800, y: 14.197954911121375 },
  { x: 1599404100, y: 14.162029790134362 },
  { x: 1599404400, y: 14.362197280607226 },
  { x: 1599404700, y: 14.36910867041331 },
  { x: 1599405000, y: 14.382392476455081 },
  { x: 1599405300, y: 14.292621459732112 },
  { x: 1599405600, y: 14.097019003642917 },
  { x: 1599405900, y: 14.079945398793907 },
  { x: 1599406200, y: 14.076148611356894 },
  { x: 1599406500, y: 13.992201051735524 },
  { x: 1599406800, y: 13.995594828196092 },
  { x: 1599407100, y: 14.124347226088318 },
  { x: 1599407400, y: 14.191399844577855 },
  { x: 1599407700, y: 14.264694401856321 },
  { x: 1599408000, y: 14.30645336296372 },
  { x: 1599408300, y: 14.31777973506515 },
  { x: 1599408600, y: 14.187351754400991 },
  { x: 1599408900, y: 14.176872791766423 },
  { x: 1599409200, y: 14.271280379724914 },
  { x: 1599409500, y: 14.432884102381049 },
  { x: 1599409800, y: 14.467671908752743 },
  { x: 1599410100, y: 15.121146759523485 },
  { x: 1599410400, y: 15.236105352363854 },
  { x: 1599410700, y: 15.126824958843844 },
  { x: 1599411000, y: 15.208413167914728 },
  { x: 1599411300, y: 15.118216743473404 },
  { x: 1599411600, y: 15.195781293775017 },
  { x: 1599411900, y: 15.230109105089937 },
  { x: 1599412200, y: 15.140901408285874 },
  { x: 1599412500, y: 15.119803571668992 },
  { x: 1599412800, y: 15.139570267636046 },
  { x: 1599413100, y: 15.12392853408431 },
  { x: 1599413400, y: 15.117135028036559 },
  { x: 1599413700, y: 15.11972342119141 },
  { x: 1599414000, y: 15.34005934436825 },
  { x: 1599414300, y: 15.350015591700533 },
  { x: 1599414600, y: 15.405170247952055 },
  { x: 1599414900, y: 15.371431254730883 },
  { x: 1599415200, y: 15.398950535379393 },
  { x: 1599415500, y: 15.415166602704865 },
  { x: 1599415800, y: 15.409932548726035 },
  { x: 1599416100, y: 15.366738620515077 },
  { x: 1599416400, y: 15.472682881132808 },
  { x: 1599416700, y: 15.589310964044772 },
  { x: 1599417000, y: 15.595219021978668 },
  { x: 1599417300, y: 15.626289917945568 },
  { x: 1599417600, y: 15.750368820561116 },
  { x: 1599417900, y: 15.780987033250549 },
  { x: 1599418200, y: 15.79857411307785 },
  { x: 1599418500, y: 15.761864476430857 },
  { x: 1599418800, y: 15.766349455214023 },
  { x: 1599419100, y: 15.717553859353314 },
  { x: 1599419400, y: 15.703017058588681 },
  { x: 1599419700, y: 15.763119734733694 },
  { x: 1599420000, y: 15.776548107974321 },
  { x: 1599420300, y: 15.716587789551346 },
  { x: 1599420600, y: 15.70252427944533 },
  { x: 1599420900, y: 15.776273929750472 },
  { x: 1599421200, y: 15.827262372800355 },
  { x: 1599421500, y: 15.87161526497957 },
  { x: 1599421800, y: 15.916414879581344 },
  { x: 1599422100, y: 15.872739995797708 },
  { x: 1599422400, y: 15.987124871161226 },
  { x: 1599422700, y: 15.987132207559078 },
  { x: 1599423000, y: 15.99568432701023 },
];

export default function useChartData(asset) {
  const [daysFromFirstTx, setDaysFromFirstTx] = useState(1000);
  const dispatch = useDispatch();
  const { address, price: priceObject, exchangeAddress } = useAsset(asset);

  const { value: price } = priceObject || {};

  const { chartsForAsset, chartType, fetchingCharts } = useSelector(
    useCallbackOne(state => chartSelector(state, address), [address]),
    isEqual
  );

  const wasNotFetchingDataForTheLast5Seconds = useWasNotFetchingDataForTheLast5Seconds(
    fetchingCharts
  );

  const handleRecieveFallbackChart = useCallback(
    chartData => {
      if (!chartData.length) {
        logger.log('ðŸ‘Žï¸ðŸ“ˆï¸ - receieved no fallback chart data');
        return;
      }
      logger.log('âœ…ï¸ðŸ“ˆï¸ - fallback chart data was success');
      dispatch(assetChartsFallbackReceived(address, chartType, chartData));
    },
    [address, chartType, dispatch]
  );

  useEffect(() => {
    async function fetchDays() {
      const days = await daysFromTheFirstTx(asset.address);
      setDaysFromFirstTx(days);
    }
    if (asset.address) {
      fetchDays();
    }
  }, [asset]);

  useEffect(() => {
    if (
      !chart &&
      exchangeAddress &&
      wasNotFetchingDataForTheLast5Seconds &&
      !fetchingCharts
    ) {
      logger.log('ðŸ™ˆï¸ - no charts -- fetching fallback...');
      getChart(exchangeAddress, chartType).then(handleRecieveFallbackChart);
    }
  }, [
    chart,
    chartType,
    exchangeAddress,
    fetchingCharts,
    handleRecieveFallbackChart,
    wasNotFetchingDataForTheLast5Seconds,
  ]);

  useEffect(() => {
    dispatch(emitChartsRequest(address, chartType));
  }, [address, chartType, dispatch]);

  const updateChartType = useCallback(
    type => dispatch(chartsUpdateChartType(type)),
    [dispatch]
  );

  // Reset chart timeframe on unmount.
  useEffect(() => () => updateChartType(DEFAULT_CHART_TYPE), [updateChartType]);

  // add current price at the very end
  const filteredData = useMemo(() => {
    const now = Math.floor(Date.now() / 1000);
    return chart
      ?.filter(({ x }) => x <= now)
      .slice(0, chart.length - 1)
      .concat({ x: now, y: price });
  }, [chart, price]);

  return {
    chart: filteredData,
    charts: chartsForAsset,
    chartType,
    fetchingCharts,
    showMonth: daysFromFirstTx > 7,
    showYear: daysFromFirstTx > 30,
    updateChartType,
  };
}
